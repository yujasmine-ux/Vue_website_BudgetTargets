<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料同步中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .data-row {
            display: flex;
            gap: 0.625rem;
            margin-bottom: 0.625rem;
            flex-wrap: wrap;
        }
        input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            flex-grow: 1;
        }
        button {
            padding: 0.5rem 0.75rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            cursor: pointer;
        }
        /* 針對 disabled 狀態 */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-4xl space-y-8">

        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">JAKE-門市預算資料同步中心</h1>

        <section class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">檔案上傳同步 (CSV/Excel)</h2>
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <input type="file" id="fileInput" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                <button id="uploadFileBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-colors duration-200 w-full sm:w-auto">
                    上傳檔案並同步
                </button>
            </div>
            <p id="file-status" class="text-sm mt-4 text-center"></p>
        </section>


        <section class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">手動輸入資料</h2>
            <div id="manual-data-container" class="space-y-4">
                </div>
            <div class="flex flex-col sm:flex-row gap-4 mt-6">
                <button id="addItemBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold shadow-md transition-colors duration-200">
                    新增一筆
                </button>
                <button id="submitManualBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold shadow-md transition-colors duration-200">
                    提交並同步
                </button>
            </div>
            <p id="manual-status" class="text-sm mt-4 text-center"></p>
        </section>

        <section class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">預算表內容</h2>
            <div class="flex justify-center mb-4">
                <button id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-colors duration-200">
                    重新整理資料
                </button>
            </div>

            <div id="loading" class="text-center text-gray-500 hidden mb-4">
                <p>資料載入中...</p>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                門市名稱
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                年份
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                月份
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                金額
                            </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <p id="errorMsg" class="text-center text-red-500 hidden mt-4"></p>
        </section>
    </div>

    <script>
        // 請將此處替換為您的 FastAPI 伺服器 URL
        const API_BASE_URL = 'https://vue-fastapi-budgettargets.onrender.com';

        // DOM 元素引用
        const manualDataContainer = document.getElementById('manual-data-container');
        const addItemBtn = document.getElementById('addItemBtn');
        const submitManualBtn = document.getElementById('submitManualBtn');
        const manualStatus = document.getElementById('manual-status');

        const fileInput = document.getElementById('fileInput');
        const uploadFileBtn = document.getElementById('uploadFileBtn');
        const fileStatus = document.getElementById('file-status');

        const refreshBtn = document.getElementById('refreshBtn');
        const loadingDiv = document.getElementById('loading');
        const tableBody = document.getElementById('tableBody');
        const errorMsg = document.getElementById('errorMsg');
        
        let manualData = [];

        // 功能函式

        // 手動同步
        function addItem() {
            const newItem = {
                store_name: '', 
                year: new Date().getFullYear(), 
                month: new Date().getMonth() + 1, 
                amount: null
            };
            manualData.push(newItem);
            renderManualData();
        }

        function removeItem(index) {
            manualData.splice(index, 1);
            renderManualData();
        }

        function renderManualData() {
            manualDataContainer.innerHTML = '';
            manualData.forEach((item, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'data-row';
                rowDiv.innerHTML = `
                    <input type="text" placeholder="門市名稱" value="${item.store_name}" data-key="store_name" data-index="${index}" class="flex-1">
                    <input type="number" placeholder="年份" value="${item.year}" data-key="year" data-index="${index}" class="flex-1">
                    <input type="number" placeholder="月份" value="${item.month}" data-key="month" data-index="${index}" class="flex-1">
                    <input type="number" placeholder="金額" value="${item.amount || ''}" data-key="amount" data-index="${index}" class="flex-1">
                    <button class="remove-btn bg-red-500 hover:bg-red-600 text-white font-semibold">移除</button>
                `;
                manualDataContainer.appendChild(rowDiv);
            });
        }

        async function submitManualData() {
            manualStatus.textContent = '正在同步...';
            manualStatus.className = 'text-sm mt-4 text-center text-gray-500';

            const filteredData = manualData.filter(item => 
                item.store_name && item.year && item.month && item.amount !== null
            );

            if (filteredData.length === 0) {
                manualStatus.textContent = "請至少填寫一筆完整的資料。";
                manualStatus.className = 'text-sm mt-4 text-center text-red-500';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/manual-sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filteredData)
                });
                
                const result = await response.json();
                if (response.ok) {
                    manualStatus.textContent = `同步成功！訊息：${result.message || '資料已成功同步。'}`;
                    manualStatus.className = 'text-sm mt-4 text-center text-green-500';
                    manualData = [];
                    addItem();
                } else {
                    throw new Error(result.detail || '伺服器錯誤。');
                }
            } catch (error) {
                manualStatus.textContent = `同步失敗：${error.message}`;
                manualStatus.className = 'text-sm mt-4 text-center text-red-500';
            }
        }

        // 檔案上傳
        async function uploadFile() {
            fileStatus.textContent = '正在上傳並同步...';
            fileStatus.className = 'text-sm mt-4 text-center text-gray-500';

            const file = fileInput.files[0];
            if (!file) {
                fileStatus.textContent = "請選擇一個檔案。";
                fileStatus.className = 'text-sm mt-4 text-center text-red-500';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE_URL}/api/upload-file`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                if (response.ok) {
                    fileStatus.textContent = `同步成功！訊息：${result.message || '檔案已成功同步。'}`;
                    fileStatus.className = 'text-sm mt-4 text-center text-green-500';
                    fileInput.value = ''; // 清空檔案輸入框
                } else {
                    throw new Error(result.detail || '伺服器錯誤。');
                }
            } catch (error) {
                fileStatus.textContent = `同步失敗：${error.message}`;
                fileStatus.className = 'text-sm mt-4 text-center text-red-500';
            }
        }
        

        // 試算表資料顯示
        async function fetchData() {
            showLoading();
            errorMsg.classList.add('hidden');
            try {
                // 從 Google Apps Script 獲取資料
                const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztMSkWEzXehHGOlqjNmScthaXuiPY927gpk8UfUzsoL_sHwJYPpJSw25UOYnigyu5ZpQ/exec';
                const response = await fetch(SCRIPT_URL, { method: 'GET' });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'success') {
                    displayData(data.data);
                } else {
                    displayError(data.message || '無法從後端獲取資料。');
                }
            } catch (error) {
                displayError(`載入資料時發生錯誤: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function displayData(data) {
            tableBody.innerHTML = ''; 
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">沒有找到資料。</td></tr>`;
                return;
            }
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row[0] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row[1] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row[2] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row[3] || ''}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        function showLoading() {
            loadingDiv.classList.remove('hidden');
            refreshBtn.disabled = true;
            submitManualBtn.disabled = true;
            addItemBtn.disabled = true;
            uploadFileBtn.disabled = true;
        }

        function hideLoading() {
            loadingDiv.classList.add('hidden');
            refreshBtn.disabled = false;
            submitManualBtn.disabled = false;
            addItemBtn.disabled = false;
            uploadFileBtn.disabled = false;
        }

        function displayError(message) {
            errorMsg.textContent = message;
            errorMsg.classList.remove('hidden');
            tableBody.innerHTML = '';
        }

        // 事件監聽器
        addItemBtn.addEventListener('click', addItem);
        submitManualBtn.addEventListener('click', submitManualData);
        refreshBtn.addEventListener('click', fetchData);
        uploadFileBtn.addEventListener('click', uploadFile);

        manualDataContainer.addEventListener('input', (event) => {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            const key = input.dataset.key;
            
            if (manualData[index]) {
                manualData[index][key] = key === 'amount' || key === 'year' || key === 'month' 
                    ? parseFloat(input.value) || null 
                    : input.value;
            }
        });

        manualDataContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-btn')) {
                const rowDiv = event.target.closest('.data-row');
                const index = Array.from(manualDataContainer.children).indexOf(rowDiv);
                if (index !== -1) {
                    removeItem(index);
                }
            }
        });

        // 頁面載入時自動執行
        window.addEventListener('load', () => {
            addItem(); // 預設新增一筆空白資料
            fetchData();
        });
    </script>
</body>
</html>
```